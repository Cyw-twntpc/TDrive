# TDrive 未來發展與架構重構藍圖 (v3.2)

## 一、已完成項目 (Completed)

本章節用以記錄已完成的重大優化，以追蹤專案進度。

### **1.1 專業日誌與錯誤處理系統**

*   **狀態**：**已完成**
*   **成果**：
    1.  **啟用日誌系統**：已在程式主入口處啟用 `logger_config.py`，實現了日誌的集中管理。
    2.  **結構化日誌**：日誌儲存格式已從純文字升級為 **JSON Lines (`.json.log`)**，為未來的日誌分析工具打下基礎。
    3.  **引入自訂錯誤**：建立了 `errors.py` 模組，定義了如 `PathNotFoundError`、`ItemAlreadyExistsError` 等特定錯誤，使錯誤處理更精準。
    4.  **全面日誌替換**：已將專案中所有 `print()` 陳述句替換為結構化的 `logger` 呼叫。
    5.  **重構錯誤流程**：已將核心模組的錯誤處理機制從「回傳布林值」重構為「拋出特定錯誤」，並由服務層捕捉後進行處理。

### **1.2 資料庫遷移與雲端同步基礎**

*   **狀態**：**已完成**
*   **成果**：
    1.  **核心資料遷移至 SQLite**：已成功將應用程式的狀態管理從 `file_tree.json` 完全遷移至 SQLite 資料庫，從根本上解決了性能、原子性和擴展性瓶頸。
    2.  **DB 層增強 (`db_handler.py`)**：已在資料庫中新增 `metadata` 表，並建立了 `get_modification_time` 函式。所有資料寫入操作都會自動更新 `db_last_modified` 時間戳。
    3.  **通訊層升級 (`telegram_comms.py`)**：已廢棄基於 `file_tree.json` 的舊同步邏輯。新增了核心的 `sync_database_file` 函式，能夠透過置頂訊息、Hash 和時間戳比對，實現對 `tdrive.db` 資料庫檔案的雲端同步與版本控制。
    4.  **服務層 API 重構 (`tdrive_handler.py`)**：已全面重構為基於 ID 的操作，並在操作成功後觸發背景資料庫上傳。
    5.  **接口層適配 (`gui_main.py`)**：已建立 wrapper 函式，將新的資料庫 API 安全地暴露給前端。

### **1.3 前端重構與全面錯誤修復 (v3.2)**

*   **狀態**：**已完成**
*   **成果**：本階段完成了對前端的徹底重構與 Debug，使應用程式恢復了完整可用性。
    1.  **前端適配與重構**：
        *   `main.js` 與 `ui_handler.js` 已完全重構，以適配後端新的、基於 ID 和扁平化資料的 API。
        *   資料夾樹、檔案列表、麵包屑導覽的渲染邏輯已完全基於 `folder_id` 和 `parent_id` 進行，廢棄了舊的、基於路徑的狀態管理。
        *   所有前端操作（新增、刪除、重新命名等）均已改為傳遞 ID 給後端。
    2.  **數據同步與一致性策略**：
        *   **狀態**：**已完成**。
        *   **成果**：已實現基於「最後修改時間戳」的自動同步策略。當本地與雲端資料庫不一致時，程式會自動比較兩者的 `db_last_modified` 時間戳，並採用**時間上較新**的版本覆蓋較舊的版本，確保資料最終一致性。此策略在目前階段被認為是足夠穩健的。
    3.  **後端穩定性修復**：
        *   **解決死鎖**：修復了 `sync_database_file` 函式因遞迴呼叫導致的死鎖問題，確保了初次啟動和資料庫同步的穩定性。
        *   **修復 `TypeError`**：修正了 `db_handler.py` 中 `get_modification_time` 函式因未設定 `row_factory` 而導致的嚴重錯誤。
        *   **補全呼叫鏈**：在 `tdrive_handler.py` 中加入了缺失的 `search_db_items` 函式，打通了搜尋功能的後端鏈路。
    4.  **前端功能修復**：
        *   **登入流程**：修復了 `login.html` 中因邏輯判斷錯誤導致兩步驟驗證 (2FA) 流程無法正常進行的 Bug。
        *   **搜尋功能**：徹底修復了搜尋功能。首先補全了後端呼叫鏈，然後修正了因回傳資料缺少 `path` 資訊導致前端渲染失敗的 Bug，最終採用了更優雅的「後端傳 `parent_id`，前端生成路徑」方案。
        *   **下載/刪除功能**：修復了 `main.js` 在處理下載和刪除時，未能正確判斷項目類型（檔案/資料夾）的 Bug，確保了這些核心功能的正常運作。
        *   **傳輸重試**：修正了 `transfer_manager.js` 在「重試/繼續」上傳和下載任務時，因傳遞錯誤參數而導致失敗的 Bug。
    5.  **前端體驗優化 (UX)**：
        *   **對話方塊重構**：將提示框系統重構為「輸入框 (Prompt)」、「確認框 (Confirm)」、「提示框 (Alert)」三種，並為輸入框增加了 Enter 確認功能，為提示框移除了不必要的「取消」按鈕。
        *   **優化完成回饋**：將傳輸完成後的提示從「閃爍小方塊」改為「整個項目列背景閃爍」，使其更加醒目。同時修正了動畫與列表刷新之間的時間差問題，使體驗更流暢。
        *   **按鈕可用性**：移除了「下載/刪除」按鈕在未選擇項目時的「禁用」狀態，使其始終可點擊，並在點擊後由程式碼彈出提示，提升了易用性。

---

## 二、核心架構升級 (已完成)

本章節是整個重構計畫的核心，旨在將資料儲存從 `file_tree.json` 遷移至 SQLite，並建立配套的跨系統交易恢復機制。

### **2.1 核心資料遷移至 SQLite**

*   **狀態**：**已完成**
*   **資料庫設計**：
    #### `folders` (資料夾表)
    | 欄位名稱 | 型別 | 描述 |
    | :--- | :--- | :--- |
    | `id` | INTEGER | 主鍵，唯一識別一個資料夾。 |
    | `parent_id` | INTEGER | 指向其父資料夾的 `id`。根目錄為 `NULL`。 |
    | `name` | TEXT | 資料夾名稱。 |
    | `total_size`| REAL | 快取的資料夾總大小，預設為 0。 |
    | `modif_date`| REAL | 最後修改時間 (Unix timestamp)。 |
    *約束與索引：* 在 `(parent_id, name)` 上建立唯一索引。

    #### `files` (檔案表)
    | 欄位名稱 | 型別 | 描述 |
    | :--- | :--- | :--- |
    | `id` | INTEGER | 主鍵，唯一識別一個檔案。 |
    | `parent_id` | INTEGER | 指向其所在資料夾的 `id` (外鍵關聯 `folders.id`)。 |
    | `name` | TEXT | 檔案名稱。 |
    | `size` | REAL | 檔案大小。 |
    | `hash` | TEXT | 完整檔案的 SHA-256 雜湊值。 |
    | `modif_date`| REAL | 最後修改時間 (Unix timestamp)。 |
    *約束與索引：* 在 `(parent_id, name)` 上建立唯一索引；在 `hash` 上建立索引。

    #### `chunks` (分塊表)
    | 欄位名稱 | 型別 | 描述 |
    | :--- | :--- | :--- |
    | `id` | INTEGER | 主鍵。 |
    | `file_id` | INTEGER | 指向其所屬檔案的 `id` (外鍵關聯 `files.id`)。 |
    | `part_num` | INTEGER | 分塊的順序編號。 |
    | `message_id`| INTEGER | 該分塊在 Telegram 中的 `message_id`。 |
    | `part_hash` | TEXT | 該分塊自身的雜湊值，用於下載校驗。 |
    *約束與索引：* 在 `(file_id, part_num)` 上建立唯一索引。

    #### `metadata` (元資料表)
    | 欄位名稱 | 型別 | 描述 |
    | :--- | :--- | :--- |
    | `key` | TEXT | 主鍵，例如 `'db_last_modified'`。 |
    | `value` | TEXT | 對應的值。 |

### **2.2 跨系統交易恢復機制**

*   **動機**：資料庫交易僅保證本地原子性，此機制旨在確保**本地**與**遠端雲端**的狀態一致。
*   **實施計畫**：
    1.  **引入操作日誌**：在執行上傳、下載、刪除前，建立與帳號綁定的日誌檔案（`operation_<api_id>.lock`），記錄操作意圖與進度。
    2.  **啟動時檢查**：在用戶身份驗證成功後、加載任何數據前，增加「守門員」步驟，檢查並執行恢復邏輯。
    3.  **恢復策略**：
        *   **上傳中斷**：**安全回滾**。讀取孤兒分塊 ID，從雲端刪除，然後清除日誌。
        *   **下載中斷**：**清理**。刪除本地的暫存檔案和目錄。
        *   **刪除中斷**：**繼續**。再次嘗試從雲端刪除日誌中記錄的檔案。
    4.  **流程閉環**：僅在整個跨系統操作完全成功後，才刪除 `.lock` 檔案。

---


## 三、結構與體驗優化 (待辦)

### **3.1 狀態管理與執行緒安全 (完成)**

*   **問題描述**：全域變數 `login_state` 存在潛在的數據競爭風險。
*   **實施計畫**：建立 `TDriveService` 服務類別來封裝所有狀態和 `handler` 函式。在 `gui_main.py` 中使用其實例，從架構上消除對全域變數的依賴。

### **3.2 暫存檔案清理**

*   **問題描述**：程式異常退出會殘留 `temp_*` 暫存目錄。
*   **實施計畫**：在 `gui_main.py` 的啟動「守門員」步驟中，增加清理所有 `temp_*` 目錄的邏輯。

### **3.3 前端日誌分析器**

*   **問題描述**：JSON 格式的日誌雖然便於機器讀取，但開發者在 UI 中直接查看和分析的需求未被滿足。
*   **實施計畫**：
    1.  **後端接口**：建立一個 `eel` 函式 `get_logs()`，用於讀取 `.json.log` 檔案並回傳日誌物件列表。
    2.  **前端介面**：新增一個「日誌檢視器」頁面或彈窗，透過 `eel.get_logs()` 獲取數據，並使用 JavaScript 將其渲染在一個可排序、可篩選的 HTML 表格中。

### **3.4 穩健的串流式下載流程**

*   **問題描述**：下載大檔案時，需要額外的暫存空間來存放加密的分割檔，且在磁碟空間不足時無法提前預警。
*   **實施計畫**：
    1.  **預先佔位與空間檢查**：下載開始前，先在目標位置建立一個與下載檔案等大的「佔位檔案」，並檢查磁碟剩餘空間。若不足，則直接回報錯誤。
    2.  **串流式處理**：下載流程改為「下載一塊 -> 解密該塊 -> 寫入佔位檔案的對應位置 -> 刪除已處理的加密分塊」，循環直至完成，以最小化暫存空間。

### **3.5 智慧型空間感知上傳策略**

*   **問題描述**：上傳大檔案前，分割和加密的過程會產生大量暫存檔案，可能耗盡磁碟空間。
*   **實施計畫**：
    1.  **空間判斷**：上傳前，判斷磁碟剩餘空間是否大於上傳檔案大小的 1.2 倍。
    2.  **高效模式 (空間充足)**：採用現有流程，一次性產生所有分塊再逐一上傳。
    3.  **安全模式 (空間不足)**：啟用串流模式：「分割一塊 -> 加密 -> 上傳 -> 刪除暫存塊」，然後再處理下一個分塊，以時間換空間。

---

## 五、結論

本藍圖 v3.2 標誌著專案的一個重要里程碑。**核心的資料庫遷移、前端重構、錯誤修復與基礎同步策略現已全面完成**。應用程式目前已處於功能完整、核心穩定的可用狀態。
